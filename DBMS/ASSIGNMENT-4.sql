/*
	1. CUSTOMER( CUST_NO: INT, CNAME: VARCHAR, CITY: VARCHAR);
    2. CUST_ORDER(ORDER_NO: INT, ODATE:DATE, CUST_NO:INT, ORD_AMT:INT);
    3. ITEM(ITEM_NO:INT, UNIT_PRICE:INT);
    4. ORDER_ITEM(ORDER_NO: INT, ITEM_NO:INT, QTY: INT);
    5. WEAREHOUSE(WRH_NO:INT, CITY:VARHAR);
    6. SHIPMENT(ORDER_NO:INT, WRH_NO:INT, SHIP_DATE: DATE);

	1. CUSTOMER - CUST_NO(PK)
    2. CUST_ORDER - ORDER_NO(PK), CUST_NO(FK)
    3. ITEM - ITEM_NO(PK)
    4. ORDER_ITEM - ORDER_NO,ITEM_NO (BOTH FK)
    5. WEAREHOUSE - WRH_NO(PK)
    6. SHIPMENT - ORDER_NO,WRH_NO (BOTH FK)

*/

SET SQL_SAFE_UPDATES = 0;

CREATE DATABASE BOOKS_MANAGEMENT_SYSTEM;
USE BOOKS_MANAGEMENT_SYSTEM;


/*CUSTOMER TABLE*/
CREATE TABLE CUSTOMER(
	CUST_NO INT PRIMARY KEY,
    CNAME VARCHAR(20),
    CITY VARCHAR(20)
);

/*ORDER TABLE*/
CREATE TABLE CUST_ORDER(
	ORDER_NO INT PRIMARY KEY,
    ODATE DATE,
    CUST_NO INT, 
    FOREIGN KEY(CUST_NO) REFERENCES CUSTOMER(CUST_NO), 
    ORD_AMT INT
);

/*ITEM TABLE*/
CREATE TABLE ITEM(
	ITEM_NO INT PRIMARY KEY,
    UNIT_PRICE INT
);

/*ORDER_ITEM TABLE*/
CREATE TABLE ORDER_ITEM(
	ORDER_NO INT,
    FOREIGN KEY(ORDER_NO) REFERENCES CUST_ORDER(ORDER_NO), 
    ITEM_NO INT,
    FOREIGN KEY(ITEM_NO) REFERENCES ITEM(ITEM_NO), 
    QTY INT
);

/*WEAREHOUSE TABLE*/
CREATE TABLE WEAREHOUSE(
	WRH_NO INT PRIMARY KEY,
    CITY VARCHAR(20)
);

/*SHIPMENT TABLE*/
CREATE TABLE SHIPMENT(
	ORDER_NO INT,
    FOREIGN KEY(ORDER_NO) REFERENCES CUST_ORDER(ORDER_NO),
    WRH_NO INT,
    FOREIGN KEY(WRH_NO) REFERENCES WEAREHOUSE(WRH_NO),
    SHIP_DATE DATE
);



/* INSERT DATA INTO CUSTOMER(CUST_NO,CNAME,CITY)*/
INSERT INTO CUSTOMER VALUES
(1, 'Amar Das', 'Kolkata'),
(2, 'Avik Sarkar', 'Kolkata'),
(3, 'Jiten Bhodori', 'Delhi'),
(4, 'Kashi Biswas', 'Patna'),
(5, 'Jatin Tiwary', 'Jammu'),
(6, 'Avijit Bera', 'Dantan');

SELECT * FROM CUSTOMER;

/* INSERT DATA INTO CUST_ORDER(ORDER_NO,ODATE,CUST_NO,ORD_AMT)*/
INSERT INTO CUST_ORDER VALUES
(1001, '2025-10-01', 1, 500),
(1002, '2025-10-02', 2, 650),
(1003, '2025-10-03', 3, 700),
(1004, '2025-10-04', 4, 550),
(1005, '2025-10-05', 5, 800),
(1006, '2025-10-06', 6, 600);

SELECT * FROM CUST_ORDER;

/* INSERT DATA INTO ITEM(ITEM_NO,UNIT_PRICE)*/
INSERT INTO ITEM VALUES
(101, 100),
(102, 150),
(103, 200),
(104, 250),
(105, 300);

SELECT * FROM ITEM;

/* INSERT DATA INTO ORDER_ITEM(ORDER_NO,ITEM_NO, QTY)*/
INSERT INTO ORDER_ITEM VALUES
(1001, 101, 2),
(1001, 102, 1),

(1002, 102, 3),
(1002, 103, 2),

(1003, 104, 1),
(1003, 101, 4),

(1004, 103, 2),
(1004, 105, 1),

(1005, 104, 2),
(1005, 105, 3),

(1006, 101, 3),
(1006, 102, 2);

SELECT * FROM ORDER_ITEM;

/* INSERT DATA INTO WEAREHOUSE(WRH_NO, CITY)*/
INSERT INTO WEAREHOUSE VALUES
(201, 'Kolkata'),
(202, 'Delhi'),
(203, 'Patna'),
(204, 'Jammu'),
(205, 'Dantan');

SELECT * FROM WEAREHOUSE;

/* INSERT DATA INTO SHIPMENT(ORDER_NO, WRH_NO, SHIP_DATE)*/
INSERT INTO SHIPMENT VALUES
(1001, 201, '2025-10-02'),
(1002, 201, '2025-10-03'),
(1003, 202, '2025-10-04'),
(1004, 203, '2025-10-05'),
(1005, 204, '2025-10-06'),
(1006, 205, '2025-10-07');

SELECT * FROM WEAREHOUSE;

/* III. Produce a listing: custname, no_of_orders, avg_order_amt, where the middle column is the total number opf orders by the customer and the last column is the avarage order amount for that customer. */
SELECT 
    C.CNAME AS Customer_Name,
    COUNT(O.ORDER_NO) AS No_of_Orders,
    AVG(O.ORD_AMT) AS Avg_Order_Amount
FROM 
    CUSTOMER C
JOIN 
    CUST_ORDER O 
ON 
    C.CUST_NO = O.CUST_NO
GROUP BY 
    C.CNAME;


/* IV. List the orderNo for the orders that were shipped from all the wearehouse that the company has in a specific city. */

SELECT S.ORDER_NO
FROM SHIPMENT S
JOIN WEAREHOUSE W ON S.WRH_NO = W.WRH_NO
WHERE W.CITY = 'Kolkata';


/* V. Demonstrate how you delete itemNo 10 from the item table and make that field null in the order-item table. */

/*Step 1: Modify foreign key constraint to allow nulls on delete */
ALTER TABLE ORDER_ITEM DROP FOREIGN KEY order_item_ibfk_2;  -- ibfk_1 = Foreign key on ITEM_NO

ALTER TABLE ORDER_ITEM
ADD CONSTRAINT fk_itemno
FOREIGN KEY (ITEM_NO) REFERENCES ITEM(ITEM_NO)
ON DELETE SET NULL;

DELETE FROM ITEM WHERE ITEM_NO = 101;

